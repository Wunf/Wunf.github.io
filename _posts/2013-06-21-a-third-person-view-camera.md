---
layout: post
category : graphics related
title : "第三人称视角相机"
tagline: "总结一些经验"
tags : [camera, third person view]
---
{% include JB/setup %}

最近在学OpenGL4.0中GLSL，为了观察各种shading的效果又重写了一遍读入OBJ的组件，很是蛋疼。想用以前的代码，发现以前写得代码不堪入目还不如重新写。写着写着自然就涉及到了camera的操作，一直觉得WOW里的左键旋转相机用起来很舒服，于是就打算写一个差不多效果的来做模型的预览。
####问题描述
效果是在以物体中心为球心，观察距离为半径的球面上实现up向量沿着球体经线切线方向的观察相机。
####问题分析
无论是glu提供的OPENGL固定管线lookat函数还是传递给shader的View矩阵，一般的参数接口都是三个。第一个是相机位置中心坐标，第二个是相机指向的目标坐标，第三个是相机头顶方向的up向量。第二个参数由模型矩阵决定，可以看做是已经确定的，第一个参数又鼠标位置确定，首先要解决的问题就是根据这两个参数计算出第三个参数。然后还有个问题时鼠标运动和球面上相机位置之间的关系。
####up向量计算
这里第三个参数的计算是纯数学问题，结果可以以后拿来直接用，就先写在这里。
![image](http://github.com/wunf/Wunf.github.io/raw/master/pictures/p1.jpg)

这里假设物体中心为坐标原点，其他情况可以通过平移后处理再平移回去解决。如图所示，要求的向量为up向量。观察后发现，**up**向量与**po**向量和**oy**向量（y轴正向）共面，且**up**与**po**正交。于是，设
	up = po + t * oy 
	又 up · po = 0
令**oy**为(0, 1, 0)可以解得
	up = po + |po|^2 / yp * (0, 1, 0) 
以为要求相机**up**向量的y轴分量始终大于0（保证相机不颠倒），当位置在XOZ平面以下的时候取求得向量的相反方向即可。结论如下：
	当yp >= 0 的时候
	xup = - xp
	yup = - yp + (xp^2 + yp^2 + zp^2) / yp
	zup = - zp
	当yp < 0 的时候
	xup = xp
	yup = yp - (xp^2 + yp^2 + zp^2) / yp
	zup = zp
####鼠标控制
因为鼠标是在二维平面上运动，要把鼠标控制精确转化为似乎在三维球面上拖动相机就比较抽象。这里我自己有一个思路，虽然最后实现的结果差强人意，但可以以后继续改进。基本思想是把鼠标在屏幕上移动的距离转化为三维空间里相机在球面上划过的距离。按屏幕空间把旋转分成两维，一次绕y轴旋转，一次绕当前旋转后的物体局部坐标x轴旋转。
因为每次鼠标移动相应的时间很短，可以把鼠标移动距离近似为弧长，然后把弧长转化为旋转角度。这里需要注意的是弧长半径不是球的半径，而是当前相机所在垂直于转动轴的平面与球体所截圆的半径。如果用球体半径的话会发现在靠近转动轴的时候某一个维度的转动会十分不灵敏。
思路先大体说到这里，因为最后的实现结果还有些不尽如人意，不知道是实现过程中的问题，还是思路本身有问题。写这篇文章的时候突然想到是不是用球面坐标表示更直观一些，可以考虑用来改进以后的工作。平时也比较忙，写文章一写就是一晚上，但愿自己能够坚持下来，与君共勉之。
